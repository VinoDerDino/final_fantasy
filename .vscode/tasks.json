{
  "version": "2.0.0",
  "tasks": [

    // Ensuring dev dirs are there

    {
      "label": "make Source dir",
      "type": "shell",
      "command": "mkdir",
      "args": [
        "-p",
        "Source"
      ],
      "windows": {
        "command": "echo",
        "args": [
          "."
        ]
      }
    },
          
    // Create the build-sim directory for storing makefiles etc that build the libraries for the simulator binary.
    // We need the folder to be present or things go wrong later.
    {
      "label": "make build-sim dir",
      "type": "shell",
      "command": "mkdir",
      "args": [
        "-p",
        "build-sim"
      ],
      // windows mkdir still errors on an existing folder, so we need to do an if, and powershell seems to hate it
      "windows": {
        "command": "cmd.exe",
        "args": [
          "/d",
          "/c",
          "build-sim-setup.bat"
        ]
      }
    },

    // Create the build-sim and Source directory for storing makefiles etc that build the libraries for the simulator binary.
    {
      "label": "make build-dev dir",
      "type": "shell",
      "command": "mkdir",
      "args": [
        "-p",
        "build-dev"
      ],
      "windows": {
        "command": "cmd.exe",
        "args": [
          "/d",
          "/c",
          "build-dev-setup.bat"
        ]
      }
    },

    ///
    ///
    ///
    ///   BUILDING FOR THE SIMULATOR
    ///
    ///

    {
      "label": "CMake-sim step",
      "type": "shell",
      // Unter Nicht-Windows bleibt der Standardbefehl erhalten (z. B. "cmake ..")
      "command": "cmake",
      "args": [
        ".."
      ],
      "options": {
        "cwd": "${workspaceFolder}/build-sim",
        "shell": {
          "executable": "cmd.exe",
          "args": ["/d", "/c"]
        }
      },
      "windows": {
        // Unter Windows wird der gesamte Befehl via cmd.exe ausgeführt – mit call, damit vcvars64.bat korrekt aufgerufen wird.
        "command": "cmd.exe",
        "args": [
          "/d",
          "/c",
          "call \"C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Auxiliary\\Build\\vcvars64.bat\" && cmake -G \"NMake Makefiles\" .."
        ]
      },
      "group": {
        "kind": "build",
        "isDefault": false
      }
    },

    {
      "label": "Playdate: Build simulator",
      "type": "shell",
      // Unter Nicht-Windows bleibt "make" erhalten
      "command": "make",
      "options": {
        "cwd": "${workspaceFolder}/build-sim",
        "shell": {
          "executable": "cmd.exe",
          "args": ["/d", "/c"]
        }
      },
      "windows": {
        "command": "cmd.exe",
        "args": [
          "/d",
          "/c",
          "call \"C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Auxiliary\\Build\\vcvars64.bat\" && nmake.exe"
        ]
      },
      "dependsOrder": "sequence",
      "dependsOn": [
        "make Source dir",
        "make build-sim dir",
        "CMake-sim step"
      ],
      "group": {
        "kind": "build",
        "isDefault": true
      }
    },

    ///
    ///
    ///   BUILDING FOR THE DEVICE
    ///
    ///

    {
      "label": "CMake-dev step",
      "type": "shell",
      "command": "cmake",
      "args": [
        "-DCMAKE_TOOLCHAIN_FILE=${env:PLAYDATE_SDK_PATH}/C_API/buildsupport/arm.cmake",
        ".."
      ],
      "options": {
        "cwd": "${workspaceFolder}/build-dev",
        "shell": {
          "executable": "cmd.exe",
          "args": ["/d", "/c"]
        }
      },
      "windows": {
        // Hier wird nun der absolute Pfad genutzt anstelle der Umgebungsvariable
        "command": "cmd.exe",
        "args": [
          "/d",
          "/c",
          "call \"C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Auxiliary\\Build\\vcvars64.bat\" && cmake -G \"NMake Makefiles\" .. --toolchain=${env:PLAYDATE_SDK_PATH}/C_API/buildsupport/arm.cmake"
        ]
      },
      "group": {
        "kind": "build",
        "isDefault": false
      }
    },

    {
      "label": "Playdate: Build device",
      "type": "shell",
      "command": "make",
      "options": {
        "cwd": "${workspaceFolder}/build-dev",
        "shell": {
          "executable": "cmd.exe",
          "args": ["/d", "/c"]
        }
      },
      "windows": {
        // Hier wird ebenfalls der absolute Pfad genutzt:
        "command": "cmd.exe",
        "args": [
          "/d",
          "/c",
          "call \"C:\\Program Files\\Microsoft Visual Studio\\2022\\Community\\VC\\Auxiliary\\Build\\vcvars64.bat\" && nmake.exe"
        ]
      },
      "dependsOrder": "sequence",
      "dependsOn": [
        "make Source dir",
        "make build-dev dir",
        "CMake-dev step"
      ],
      "group": {
        "kind": "build",
        "isDefault": true
      }
    }
  ]
}